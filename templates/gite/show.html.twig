{% extends 'base.html.twig' %}

{% block title %}{{parent()}}{{ gite.name|trans }}{% endblock %}

{% block breadcrumb %}
    {% import 'macro/breadcrumb.html.twig' as breadcrumb %}
    {{ breadcrumb.render([
        {
            name: 'gite.gites',
            route: 'gite_index'
        },
        {
            name: gite.name,
            route: 'gite_show',
            params: {'slug': gite.slug}
        }
    ]) }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('styles/gite.css') }}" rel="stylesheet">
{% endblock %}

{% block body %}
    <div class="bg-gite-image w-100"
         data-image="{{ vich_uploader_asset(gite, 'backgroundImage') }}"
         style="--bg-image: url('{{ vich_uploader_asset(gite, 'backgroundImage') }}');">
        <h2 class="gite-name">{{ gite.name|title }}</h2>
    </div>

    <div class="mt-n5 position-relative container">
        <div class="row mb-4">
            <div class="row g-4">
                <!-- Colonne de gauche : Informations du gîte -->
                <div class="col-lg-8 pe-5">
                    <!-- Section principale -->
                    <div class="mb-5">
                        <h2 class="mb-3">{{ app.locale == 'fr' ? gite.title : gite.titleEn }}</h2>
                        <p class="mb-4">{{ app.locale == 'fr' ? gite.summary : gite.summaryEn }}</p>
                    </div>

                    <!-- Description -->
                    <div class="mb-5">
                        <h3 class="h4 mb-3">{{ 'gite.description'|trans }}</h3>
                        <div class="text-muted">
                            {% set description = app.locale == 'fr' ? gite.description : gite.descriptionEn %}
                            {{ description|nl2br }}
                        </div>
                    </div>

                    <!-- Équipements -->
                    <div class="mb-5">
                        <h3 class="h4 mb-4">{{ 'gite.equipment'|trans }}</h3>
                        <div class="equipment-list">
                            {% for equipment in gite.equipments %}
                                <div class="equipment-item d-flex align-items-start mb-3">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="{{ vich_uploader_asset(equipment, 'picto') }}"
                                             alt="{{ equipment.name }}"
                                             width="32"
                                             height="32"
                                             class="equipment-icon">
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="equipment-title mb-1">{{ app.locale == 'fr' ? equipment.name : equipment.nameEn }}</p>
                                        <p class="equipment-description mb-0 text-muted">{{ app.locale == 'fr' ? equipment.description : equipment.descriptionEn }}</p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Colonne de droite : Formulaire de réservation -->
                <div class="col-lg-4" data-controller="gite" data-gite-price-night-value="{{ gite.price }}">
                    <div class="reservation border shadow-sm pe-3 pb-3">
                        <div class="card">
                            {% for label, messages in app.flashes %}
                                {% for message in messages %}
                                    <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
                                        {{ message|trans }}
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                    </div>
                                {% endfor %}
                            {% endfor %}

                            <div class="text-center py-3">
                                <h4 class="mb-0 reservation-color">{{ 'gite.booking_request'|trans }}</h4>
                            </div>
                            <div class="p-4">
                                {{ form_start(form, {'attr': {'class': 'reservation-form'}}) }}

                                <!-- Dates -->
                                <div class="row g-2 mb-4">
                                    <div class="col-6">
                                        {{ form_row(form.dateArrival, {'attr': {
                                            'data-action': 'change->gite#updateDateRecap',
                                            'data-gite-target': 'dateArrival',
                                        }}) }}
                                    </div>
                                    <div class="col-6">
                                        {{ form_row(form.dateDeparture, {'attr': {
                                            'data-action': 'change->gite#updateDateRecap',
                                            'data-gite-target': 'dateDeparture'
                                        }}) }}
                                    </div>
                                </div>

                                <!-- Nombre de voyageurs -->
                                <div class="mb-4">
                                    <p class="text-uppercase reservation-color mb-3">{{ 'gite.nb_traveller'|trans }}</p>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            {{ form_row(form.nbAdult, {'attr': {
                                                'min': 1,
                                                'data-action': 'change->gite#updatePersonRecap',
                                                'data-gite-target': 'personAdult'
                                            }}) }}
                                        </div>
                                        <div class="col-6">
                                            {{ form_row(form.nbChild, {'attr': {
                                                'min': 0,
                                                'data-action': 'change->gite#updatePersonRecap',
                                                'data-gite-target': 'personChild'
                                            }}) }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Informations personnelles -->
                                <div class="mb-4">
                                    <p class="text-uppercase reservation-color mb-3">{{ 'gite.your_info'|trans }}</p>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            {{ form_row(form.lastname) }}
                                        </div>
                                        <div class="col-6">
                                            {{ form_row(form.firstname) }}
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        {{ form_row(form.mail) }}
                                    </div>
                                </div>

                                <!-- Récapitulatif -->
                                <div class="p-3 mb-4">
                                    <p class="text-uppercase reservation-color mb-3">{{ 'gite.recap'|trans }}</p>
                                    <div class="small text-muted">
                                        <p class="mb-2">
                                            {{ 'gite.from'|trans }} <span data-gite-target="recapArrival" class="fw-bold">--/--/----</span>
                                            {{ 'gite.to'|trans }} <span data-gite-target="recapDeparture" class="fw-bold">--/--/----</span>
                                        </p>
                                        <p class="mb-2">
                                            {{ 'gite.recap_nights_prefix'|trans }} <span data-gite-target="recapNight" class="fw-bold">-</span> {{ 'gite.recap_nights_suffix'|trans }}
                                            {{ 'gite.recap_adults_prefix'|trans }} <span data-gite-target="recapPersonAdult" class="fw-bold">-</span> {{ 'gite.recap_adults_suffix'|trans }}
                                            {{ 'gite.recap_children_prefix'|trans }} <span data-gite-target="recapPersonChild" class="fw-bold">0</span> {{ 'gite.recap_children_suffix'|trans }}
                                        </p>
                                        <div class="border-top pt-2 mt-3">
                                            <div class="d-flex justify-content-between">
                                                <span class="fw-bold">{{ 'gite.total'|trans }} :</span>
                                                <span
                                                    class="fw-bold"
                                                    data-gite-target="recapPrice"
                                                >--- €**</span>
                                            </div>
                                            <small class="text-muted d-block mt-1">
                                                ** {{ 'gite.disclaimer'|trans }}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bouton de soumission -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">
                                        {{ 'contact.submit'|trans|upper }}
                                    </button>
                                </div>

                                {{ form_end(form) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% set imagesData = [] %}
        {% for image in gite.giteImages %}
            {% set imagesData = imagesData|merge([{
            'src': vich_uploader_asset(image, 'image')|imagine_filter('extra_large'),
            'alt': image.name,
            'thumbnail': vich_uploader_asset(image, 'image')|imagine_filter('thumbnail')
        }]) %}
    {% endfor %}
    <div class="mt-n5 mb-5 position-relative container" data-controller="lightbox" data-lightbox-images-value="{{ imagesData|json_encode|e('html_attr') }}" data-lightbox-current-index-value="0">
        {% set imageBatch = gite.giteImages|slice(0, 5) %}

        {% if imageBatch|length == 5 %}
            {% set images = gite.giteImages %}
            {% set mainImage = images[0] %}
            {% set gridImages = images|slice(1, 4) %}
            <div class="row g-3" style="height: 400px;">
                <!-- Grande image principale -->
                <div class="col-md-6 h-100">
                    <div class="position-relative h-100 overflow-hidden shadow-sm">
                        <img
                            role="button"
                            data-action="click->lightbox#open"
                            data-lightbox-index-param="0"
                            src="{{ vich_uploader_asset(mainImage, 'image')|imagine_filter('large') }}"
                            class="w-100 h-100 object-fit-cover hover-scale"
                            alt="{{ mainImage.name }}">
                    </div>
                </div>

                <!-- Grille 2x2 d'images -->
                <div class="col-md-6 h-100">
                    <div class="grid-2x2 h-100">
                        {% for image in gridImages %}
                            <div class="grid-item position-relative overflow-hidden shadow-sm">
                                <img
                                    role="button"
                                    data-action="click->lightbox#open"
                                    data-lightbox-index-param="{{ loop.index }}"
                                    src="{{ vich_uploader_asset(image, 'image')|imagine_filter('medium') }}"
                                    class="w-100 h-100 object-fit-cover hover-scale"
                                    alt="{{ image.name }}">
                            </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        {% else %}
            <div class="row row-cols-1 row-cols-md-4 g-4">
                {% for image in gite.giteImages %}
                    <div class="col">
                        <div class="card h-100">
                            <img
                                role="button"
                                data-action="click->lightbox#open"
                                data-lightbox-index-param="{{ loop.index - 1 }}"
                                src="{{ vich_uploader_asset(image, 'image')|imagine_filter('medium') }}"
                                class="w-100 h-100 object-fit-cover hover-scale"
                                alt="{{ image.name }}">
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div>
            <div class="modal fade" tabindex="-1" aria-hidden="true" data-lightbox-target="modal">
                <div class="modal-dialog modal-fullscreen">
                    <div class="modal-content bg-dark">
                        <!-- Header avec compteur et fermer -->
                        <div class="modal-header border-0 position-absolute top-0 end-0 z-3">
                            <div class="d-flex gap-2">
                                <span class="badge bg-dark bg-opacity-75 fs-6 me-3"
                                      data-lightbox-target="counter">
                                    1 / {{ gite.giteImages|length }}
                                </span>
                                <button type="button" class="btn-close btn-close-white"
                                        data-action="lightbox#close">
                                </button>
                            </div>
                        </div>

                        <div class="modal-body p-0 d-flex align-items-center justify-content-center position-relative">
                            <img
                                data-lightbox-target="currentImage"
                                class="img-fluid"
                                style="max-height: 90vh; max-width: 90vw; object-fit: contain;">

                            <!-- Bouton précédent -->
                            <button class="btn btn-light btn-lg position-absolute start-0 top-50 translate-middle-y ms-3 rounded-circle"
                                    data-action="lightbox#previous"
                                    data-lightbox-target="prevBtn"
                                    style="width: 60px; height: 60px; opacity: 0.8;">
                                <i class="fa-classic fa-solid fa-arrow-left fa-fw"></i>
                            </button>

                            <!-- Bouton suivant -->
                            <button class="btn btn-light btn-lg position-absolute end-0 top-50 translate-middle-y me-3 rounded-circle"
                                    data-action="click->lightbox#next"
                                    data-lightbox-target="nextBtn"
                                    style="width: 60px; height: 60px; opacity: 0.8;">
                                <i class="fa-classic fa-solid fa-arrow-right fa-fw"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="py-3"></div>
{% endblock %}
